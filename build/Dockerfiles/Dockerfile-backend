FROM node:10.11.0

USER root

ENV NPM_CONFIG_LOGLEVEL warn
RUN npm install -g nodemon@1.18.3 ts-node@7.0.1
RUN apt-get update -y && apt-get install -y postgresql-client

RUN mkdir -p /app
WORKDIR /app

COPY ./bedes-backend/ /app
COPY ./bedes-common /bedes-common
COPY ./environment /environment
RUN mkdir -p logs && mkdir -p /entrypoint
COPY ./build/lib/backend-entrypoint.sh /entrypoint

RUN chown -R node.node /app
RUN chown -R node.node /bedes-common

USER node

WORKDIR /bedes-common
RUN rm -rf node_modules && npm install

WORKDIR /app
RUN rm -rf node_modules && npm install

CMD ["/entrypoint/backend-entrypoint.sh"]
EXPOSE 3000

