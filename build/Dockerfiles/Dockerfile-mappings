FROM node:10.11.0

ARG NODE_USER_ID=500
ARG NODE_GROUP_ID=20

ENV NPM_CONFIG_LOGLEVEL warn
RUN npm install -g ts-node@7.0.1
RUN apt-get update -y
RUN mkdir /scripts
WORKDIR /scripts
# RUN groupadd nodenew -g 1000
# RUN groupmod -g 200 dialout
# RUN groupmod -g ${NODE_GROUP_ID}} node
# RUN usermod -u 501 node && usermod -g 20 node
RUN usermod -u ${NODE_USER_ID} node
COPY ./scripts /scripts
COPY ./bedes-common /bedes-common
COPY ./bedes-backend /bedes-backend
COPY ./bedes-mappings /bedes-mappings
# RUN mkdir logs && mkdir /entrypoint 
# COPY ./build/lib/backend-entrypoint.sh /entrypoint

RUN chown -R node.node /scripts
RUN chown -R node.node /bedes-common
RUN chown -R node.node /bedes-backend
RUN chown -R node.node /bedes-mappings
USER node
WORKDIR /bedes-common
RUN rm -rf node_modules && npm install
WORKDIR /bedes-backend
RUN rm -rf node_modules && npm install
WORKDIR /scripts/ts
RUN rm -rf node_modules && npm install
CMD ["npm", "run", "load-all"]
EXPOSE 3000
